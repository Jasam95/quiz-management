<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title th:text="${quiz.title} + ' - Attempt'">Quiz Attempt</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .question { display: none; }
    .question.active { display: block; }
  </style>
</head>
<body class="bg-light">

<div class="container mt-5">
  <h2 class="mb-4 text-center" th:text="${quiz.title}">Quiz Title</h2>

  <!-- Timer -->
  <div class="alert alert-warning text-center fs-5">
    Time Remaining: <span id="timer">00:00</span>
  </div>

  <form th:action="@{/participants/quizzes/{quizId}/attempt(quizId=${quiz.id})}" th:object="${attempt}" method="post" id="quizForm">
    <input type="hidden" th:name="quizId" th:value="${quiz.id}"/>

    <!-- Questions step-by-step -->
    <div th:each="question, iterStat : ${quiz.questions}" class="question" th:classappend="${iterStat.index == 0}? 'active'">
      <h5>Q<span th:text="${iterStat.index + 1}">1</span>:
        <span th:text="${question.questionText}">Question Text</span>
      </h5>

        <div th:each="choice : ${question.choices}" class="form-check">
          <input class="form-check-input"
                 type="radio"
                 th:id="${'q'+question.id+'c'+choice.id}"
                 th:name="'selectedChoiceId_' + ${question.id}"
                 th:value="${choice.id}">
          <label class="form-check-label" th:for="${'q'+question.id+'c'+choice.id}"
                 th:text="${choice.text}">Choice</label>
        </div>

      <!-- Navigation buttons -->
      <div class="mt-3 d-flex justify-content-between">
        <button type="button" class="btn btn-secondary prev-btn" th:if="${iterStat.index != 0}">Previous</button>
        <button type="button" class="btn btn-primary next-btn"
                th:if="${iterStat.index != quiz.questions.size() - 1}">Next</button>
        <button type="submit" class="btn btn-success" th:if="${iterStat.index == quiz.questions.size() -1}">Submit Quiz</button>
      </div>
    </div>
  </form>
</div>

<script th:inline="javascript">
  /*<![CDATA[*/
  // Timer
  let duration = /*[[${durationSeconds}]]*/ 600;
  const timerElement = document.getElementById('timer');
  const form = document.getElementById('quizForm');

  function formatTime(seconds) {
      let m = Math.floor(seconds / 60);
      let s = seconds % 60;
      return (m < 10 ? '0' + m : m) + ':' + (s < 10 ? '0' + s : s);
  }

  function countdown() {
      timerElement.textContent = formatTime(duration);
      if (duration <= 0) {
          alert("Time is up! Submitting your quiz...");
          form.submit();
          return;
      }
      duration--;
      setTimeout(countdown, 1000);
  }
  countdown();

  // Question navigation
  const questions = document.querySelectorAll('.question');
  questions.forEach((q, idx) => {
      const nextBtn = q.querySelector('.next-btn');
      const prevBtn = q.querySelector('.prev-btn');

      if (nextBtn) {
          nextBtn.addEventListener('click', () => {
              q.classList.remove('active');
              questions[idx + 1].classList.add('active');
          });
      }
      if (prevBtn) {
          prevBtn.addEventListener('click', () => {
              q.classList.remove('active');
              questions[idx - 1].classList.add('active');
          });
      }
  });
  /*]]>*/
</script>

</body>
</html>
