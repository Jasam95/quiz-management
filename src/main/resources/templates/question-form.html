<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${question.id == null} ? 'Create Question' : 'Edit Question'">Create Question</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="bg-light">

<div class="container mt-5">
    <div class="card shadow-lg border-0">
        <div class="card-header bg-primary text-white">
            <h4 th:if="${question.id == null}" class="mb-0">üß© Create Question</h4>
            <h4 th:if="${question.id != null}" class="mb-0">üìù Edit Question</h4>
        </div>

        <div class="card-body">
            <form th:action="${question.id == null} ? @{/admin/questions/save} : @{/admin/questions/edit/{id}(id=${question.id})}"
                  th:object="${question}" method="post" onsubmit="return validateChoices()">
                <div class="mb-3">
                    <label class="form-label">Select Quiz</label>
                    <select class="form-select" th:field="*{quiz.id}" required>
                        <option value="">-- Select Quiz --</option>
                        <option th:each="quiz : ${quizzes}"
                                th:value="${quiz.id}"
                                th:text="${quiz.title}"></option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">Question Text</label>
                    <textarea class="form-control" th:field="*{questionText}" rows="3" required></textarea>
                </div>

                <h5 class="mt-3">Enter Choices (Select one correct answer)</h5>

                <div class="mt-3" th:each="choice, iterStat : *{choices}">
                    <div class="input-group mb-2">
                        <!-- Label -->
                        <span class="input-group-text" th:text="'Choice ' + (${iterStat.index + 1})"></span>

                        <!-- Choice text input -->
                        <input type="text"
                               class="form-control"
                               th:field="*{choices[__${iterStat.index}__].text}"
                               placeholder="Enter choice text"
                               required />

                        <!-- Validation error for text -->
                        <div class="text-danger"
                             th:if="${#fields.hasErrors('choices[' + iterStat.index + '].text')}"
                             th:errors="*{choices[__${iterStat.index}__].text}"></div>

                        <!-- Correct choice checkbox -->
                        <div class="input-group-text">
                            <input type="checkbox"
                                   th:field="*{choices[__${iterStat.index}__].isCorrect}"
                                   class="form-check-input mt-0" />
                        </div>
                    </div>
                </div>

                <p class="text-muted small mt-2">Only one option should be marked as correct.</p>

                <div class="mb-3">
                    <label class="form-label">Points</label>
                    <input type="number" class="form-control" th:field="*{points}" min="0.5" step="0.5" required>
                </div>

                <div id="choiceAlert" class="alert alert-danger d-none mt-3" role="alert">
                    Please mark exactly one choice as correct.
                </div>
<!--                <div th:if="${errorMessage}" class="alert alert-danger mt-3" th:text="${errorMessage}"></div>-->


                <div class="text-end mt-4">
                    <button type="submit" class="btn btn-success">üíæ Save Question</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function validateChoices() {
        const alertBox = document.getElementById('choiceAlert');
        const checkboxes = document.querySelectorAll('input[type="checkbox"][name$="isCorrect"]');
        const checked = Array.from(checkboxes).filter(cb => cb.checked);

        // Hide alert by default
        alertBox.classList.add('d-none');

        if (checked.length !== 1) {
            alertBox.textContent = "Please mark exactly one choice as correct.";
            alertBox.classList.remove('d-none');
            return false;
        }

        return true;
    }
</script>


</body>
</html>
